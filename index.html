<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>JSON Viewer & Tools</title>
    <style>
      :root {
        --gap: 12px;
        --radius: 12px;
      }
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu,
          Cantarell, "Noto Sans", sans-serif;
        margin: 0;
        padding: 24px;
        background: #0b0d10;
        color: #e9eef3;
      }
      h1 {
        margin: 0 0 16px;
        font-size: 20px;
      }
      .app {
        display: grid;
        grid-template-columns: 320px 1fr;
        gap: var(--gap);
        align-items: start;
      }
      .card {
        background: #151a20;
        border: 1px solid #232a33;
        border-radius: var(--radius);
        padding: 14px;
      }
      .controls {
        display: grid;
        gap: 10px;
        grid-template-columns: 1fr 1fr;
      }
      .controls > * {
        min-width: 0;
      }
      input[type="text"],
      select,
      button {
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid #2b3541;
        background: #0f1318;
        color: #e9eef3;
      }
      button {
        cursor: pointer;
      }
      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .list {
        max-height: 70vh;
        overflow: auto;
        margin-top: 12px;
      }
      .item {
        padding: 10px 12px;
        border: 1px solid #232a33;
        border-radius: 10px;
        margin-bottom: 8px;
        background: #0f1318;
        display: grid;
        gap: 6px;
      }
      .item.selected {
        outline: 2px solid #4c8bf5;
      }
      .badgen {
        opacity: 0.8;
        font-size: 12px;
      }
      .stack {
        display: grid;
        gap: 8px;
      }
      .row {
        display: flex;
        gap: 8px;
      }
      .row > * {
        flex: 1;
      }
      pre {
        white-space: pre-wrap;
        word-break: break-word;
        background: #0f1318;
        border: 1px solid #232a33;
        border-radius: 10px;
        padding: 12px;
        margin: 0;
        max-height: 70vh;
        overflow: auto;
      }
      .muted {
        color: #9fb1c4;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <h1>–ü–µ—Ä–µ–≥–ª—è–¥ —Ç–∞ –º–∞–Ω—ñ–ø—É–ª—è—Ü—ñ—ó –∑ <code>data.json</code></h1>

    <div class="app">
      <!-- –õ—ñ–≤–∞ –ø–∞–Ω–µ–ª—å: —Ñ—ñ–ª—å—Ç—Ä, —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è, —Å–ø–∏—Å–æ–∫ -->
      <div class="card">
        <div class="stack">
          <input id="q" type="text" placeholder="–ü–æ—à—É–∫ " />
          <div class="controls">
            <select id="sortField" title="–ü–æ–ª–µ –¥–ª—è —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è">
              <option value="name">name</option>
              <option value="price">price</option>
              <option value="id">id</option>
            </select>
            <select id="sortDir" title="–ü–æ—Ä—è–¥–æ–∫">
              <option value="asc">‚Üë –∑—Ä–æ—Å—Ç–∞–Ω–Ω—è</option>
              <option value="desc">‚Üì —Å–ø–∞–¥–∞–Ω–Ω—è</option>
            </select>
          </div>
          <div class="row">
            <button id="btnAdd">+ –î–æ–¥–∞—Ç–∏ –¥–µ–º–æ-–æ–± º—î–∫—Ç</button>
            <button id="btnReset" title="–ü–æ–≤–µ—Ä–Ω—É—Ç–∏ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω—ñ –¥–∞–Ω—ñ">
              ‚Ü∫ –°–∫–∏–Ω—É—Ç–∏
            </button>
          </div>
          <div class="row">
            <button id="btnUp10" disabled>‚Üë –¶—ñ–Ω–∞ +10% (–≤–∏–¥—ñ–ª–µ–Ω–µ)</button>
            <button id="btnDelete" disabled>üóë –í–∏–¥–∞–ª–∏—Ç–∏ (–≤–∏–¥—ñ–ª–µ–Ω–µ)</button>
          </div>
        </div>

        <div class="list" id="list"></div>
      </div>

      <!-- –ü—Ä–∞–≤–∞ –ø–∞–Ω–µ–ª—å: –¥–µ—Ç–∞–ª—ñ –≤–∏–¥—ñ–ª–µ–Ω–æ–≥–æ –µ–ª–µ–º–µ–Ω—Ç–∞ / —Å–∏—Ä–æ–≤–∏–π JSON -->
      <div class="card stack">
        <div>
          <div class="row">
            <button id="btnToggleRaw">–ü–æ–∫–∞–∑–∞—Ç–∏ —Å–∏—Ä–∏–π JSON</button>
            <button id="btnCopy" title="–°–∫–æ–ø—ñ—é–≤–∞—Ç–∏ –ø–æ—Ç–æ—á–Ω—ñ –¥–∞–Ω—ñ –≤ –±—É—Ñ–µ—Ä">
              –ö–æ–ø—ñ—é–≤–∞—Ç–∏ –≤—Å—ñ –¥–∞–Ω—ñ
            </button>
          </div>
        </div>
        <div id="detailsWrap" class="stack"></div>
        <pre id="raw" hidden></pre>
                <table>
        <thead>
    <tr>
      <th scope="col">chatNumber</th>
      <th scope="col">depositAmount</th>
      <th scope="col">depositDate</th>
      <th scope="col">depositType</th>
      <th scope="col">leadID</th>
      <th scope="col">workerID</th>
    </tr>
        </thead>
<tbody id="tableBody">
  </tbody>
        </table>
      </div>
      </div>

    <div
      id="drop-area"
      style="border: 2px dashed #ccc; padding: 20px; text-align: center"
    >
      Drag and drop JSON files here
    </div>
    <pre id="output"></pre>

    <script>

    let resultfile;
      const dropArea = document.getElementById('drop-area');
const output = document.getElementById('output');

// Prevent default drag behaviors
['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
  dropArea.addEventListener(eventName, preventDefaults, false);
});

function preventDefaults(e) {
  e.preventDefault();
  e.stopPropagation();
}

// Highlight drop area when item is dragged over it
['dragenter', 'dragover'].forEach(eventName => {
  dropArea.addEventListener(eventName, highlight, false);
});

['dragleave', 'drop'].forEach(eventName => {
  dropArea.addEventListener(eventName, unhighlight, false);
});

function highlight(e) {
  dropArea.classList.add('highlight');
}

function unhighlight(e) {
  dropArea.classList.remove('highlight');
}

// Handle dropped files
dropArea.addEventListener('drop', handleDrop, false);

function handleDrop(e) {
  const dt = e.dataTransfer;
  const files = dt.files;

  handleFiles(files);
}

function handleFiles(files) {
  for (let i = 0; i < files.length; i++) {
    const file = files[i];
    if (file.type === 'application/json') { // Ensure it's a JSON file
      const reader = new FileReader();

      reader.onload = function(event) {
        try {
          const jsonContent = JSON.parse(event.target.result);
          // output.textContent = JSON.stringify(jsonContent, null, 2); // Display formatted JSON
          // You can now work with the 'jsonContent' object
          console.log('Parsed JSON:', jsonContent);
          // resultfile = jsonContent
          render(jsonContent);
        } catch (error) {
          output.textContent = 'Error parsing JSON: ' + error.message;
          console.error('Error parsing JSON:', error);
        }
      };
      // resultfile = reader.readAsText(file).messages;
      
      reader.readAsText(file);
    } else {
      output.textContent = 'Please drop a valid JSON file.';
    }
  }
}

      function render(resultfile) {
        let resultData = [];
        // let resultItem = {};
        let listOfNotifications = resultfile.messages.filter((item) => {
          if (item.from == "Crm tg" && item.text.length >= 13) return true;
        });

        let listOfDeposits = resultfile.messages.filter((item) => {
          if (item.from == "aza") return true;
        });

        listOfNotifications.forEach((element) => {
          let resultItem = {};    
          let depositObject = listOfDeposits.find((dep) => dep.reply_to_message_id == element.id);

          resultItem.depositType = element.text[0].text.split("")[2] =="–§"? "FD": "RD";
          resultItem.chatNumber = element.text[0].text.split(" ")[3];
          resultItem.workerID = element.text[8].text;
          resultItem.leadID = element.text[12].text;
          resultItem.depositDate = element.date.split("T")[0];
          resultItem.depositAmount =depositObject.text.split("+")[1] == undefined ? 'not a dep' :depositObject.text.split("+")[1] + ' 000';
          resultData.push(resultItem)

      let tbinnerHTML = `    
        <tr>
      <th scope="row">${resultItem.chatNumber}</th>
      <th scope="row">${resultItem.depositAmount}</th>
      <th scope="row">${resultItem.depositDate}</th>
      <th scope="row">${resultItem.depositType}</th>
      <th scope="row">${resultItem.leadID}</th>
      <th scope="row">${resultItem.workerID}</th>
    </tr>`
      // console.log(element.text[0].text.split("")[1] =="–§")

document.getElementById('tableBody').innerHTML += tbinnerHTML
        });

let csv = convertToCSV(resultData)
      console.log(csv)

    CSVFile = new Blob([csv], { type: "text/csv" });

    // Create to temporary link to initiate
    // download process
    let temp_link = document.createElement('a');

    // Download csv file
    temp_link.download = "GfG.csv";
    let url = window.URL.createObjectURL(CSVFile);
    temp_link.href = url;

    // This link should not be displayed
    temp_link.style.display = "none";
    document.body.appendChild(temp_link);

    // Automatically click the link to trigger download 
    temp_link.click();
    document.body.removeChild(temp_link);

      }

    function convertToCSV(data) {
        const headers = Object.keys(data[0]).join(',');
        const rows = data.map(row => Object.values(row).join(','));
        return [headers, ...rows].join('\n');
    }

      // –°—Ç–∞—Ä—Ç
      // loadData();
    </script>
  </body>
</html>
